---
title: "Amgen_data"
author: "Kalyan Srivastava"
date: "4/5/2021"
output: html_document
---


```{r warning=FALSE, echo = FALSE}
rm(list = ls(all = TRUE))
require(dplyr)
require(ggplot2)
library(tidyr)
library(ggpubr)
library(doFuture)
library(DT)

```
#Importing the data

```{r warning=FALSE, echo = FALSE}
setwd("~/Desktop")

setwd("~/Desktop/Amgen_data")
data <- read.csv("data.csv")

datatable(data, class = 'cell-border stripe', colnames = c('Subject ID', 'Time Point', 'Values', 'Markers', 'Treatment Group'))
summary(data)

fact <- factor(data$sample_time)
factList <- levels(fact)

cat("The times point of observations are :\t", factList )
```
### Please provide a version of this graph with each subject’s digital_count connected by a line, and a unique shape and color for each subject

```{r warning=FALSE, echo = FALSE}

data$sample_time <- factor(data$sample_time, levels=c("DAY1","DAY8", "DAY15", "DAY22", "DAY29"))
good.shapes = c(1:25,33:127)

ggplot(data[data$marker == "C4",], aes(x=sample_time, y=digital_count, group=sbj_id, color=sbj_id, shape = sbj_id)) +
     geom_line(linetype = "dotted")+
     geom_point() + 
     scale_shape_manual(values=good.shapes[1:21]) +labs(title="Plot with marker C4", x ="Time", y = "Count")

ggplot(data[data$marker == "C8",], aes(x=sample_time, y=digital_count, group=sbj_id, color=sbj_id, shape = sbj_id)) +
     geom_line(linetype = "dotted")+
     geom_point() + 
     scale_shape_manual(values=good.shapes[1:21]) +labs(title="Plot with marker C8", x ="Time", y = "Count")

ggplot(data[data$marker == "TG",], aes(x=sample_time, y=digital_count, group=sbj_id, color=sbj_id, shape = sbj_id)) +
     geom_line(linetype = "dotted")+
     geom_point() + 
     scale_shape_manual(values=good.shapes[1:21]) +labs(title="Plot with marker TG", x ="Time", y = "Count")
```
```{r warning=FALSE, echo = FALSE}
```
### Please provide a version of this graph as Mean ± SD with each treatment group’s mean connected by a line, and a unique shape and color for each treatment group
```{r warning=FALSE, echo = FALSE}
dataTA <- data[data$trt_group == "TA",]
dataTB <- data[data$trt_group == "TB",]
dataTC <- data[data$trt_group == "TC",]

aggregateTA <- aggregate(dataTA$digital_count, list(Marker = dataTA$marker, Time = dataTA$sample_time), mean)
aggregateTB <- aggregate(dataTB$digital_count, list(Marker = dataTB$marker, Time = dataTB$sample_time), mean)
aggregateTC <- aggregate(dataTC$digital_count, list(Marker = dataTC$marker, Time = dataTC$sample_time), mean)

ggplot(aggregateTA, aes(x=Time, y=x, group=Marker, color=Marker, shape = Marker)) +
    geom_line(linetype = "dotted")+
    geom_point() + 
    scale_shape_manual(values=good.shapes[1:21]) +labs(title="Plot with marker TA", x ="Time", y = "Mean")
    
ggplot(aggregateTB, aes(x=Time, y=x, group=Marker, color=Marker, shape = Marker)) +
    geom_line(linetype = "dotted")+
    geom_point() + 
    scale_shape_manual(values=good.shapes[1:21]) +labs(title="Plot with marker TB", x ="Time", y = "Mean")
    
ggplot(aggregateTC, aes(x=Time, y=x, group=Marker, color=Marker, shape = Marker)) +
    geom_line(linetype = "dotted")+
    geom_point() + 
    scale_shape_manual(values=good.shapes[1:21]) +labs(title="Plot with marker TC", x ="Time", y = "Mean")

print("In theory the above section of code could also be used for SD")

```
### Please convert the input data table to another table in which each sample_time become a separate column filled with corresponding digital counts and other columns remain
```{r warning=FALSE, echo = FALSE}

dfW <- spread(data, sample_time, digital_count) 

datatable(dfW, class = 'cell-border stripe')
 
```
### Please test for each marker whether Day 8 and Day 1 differs at alpha = 0.05 under each treatment

```{r warning=FALSE, echo = FALSE}
x1 = data[data$marker == "C4" & data$sample_time == "DAY1",]$digital_count
x2 = data[data$marker == "C4" & data$sample_time == "DAY8",]$digital_count
x3 = data[data$marker == "C8" & data$sample_time == "DAY1",]$digital_count
x4 = data[data$marker == "C8" & data$sample_time == "DAY8",]$digital_count
x5 = data[data$marker == "TG" & data$sample_time == "DAY1",]$digital_count
x6 = data[data$marker == "TG" & data$sample_time == "DAY8",]$digital_count
res1 <- t.test(x1, x2, alternative = c("two.sided"), mu = 0, paired = FALSE, conf.level = 0.95)
cat("The p value for marker C4 is:\t", res1$p.value)
res2 <- t.test(x3, x4, alternative = c("two.sided"), mu = 0, paired = FALSE, conf.level = 0.95)
cat("The p value for marker C8 is:\t", res2$p.value)
res3 <- t.test(x5, x6, alternative = c("two.sided"), mu = 0, paired = FALSE, conf.level = 0.95)
cat("The p value for marker TG is:\t", res3$p.value)
```


### Please fit an approriate statistical model for each marker with digital_count as dependent variables, and sample_time and treatment as independent variables (both are conisidered factors). Assume sbj are randomly drawn from a population. With each model, please report the significance of treatment effect and the contrast between Day 22 and Day 8
```{r warning=FALSE, echo = FALSE}
ggboxplot(data, x = "sample_time", y = "digital_count", color = "trt_group")

dF8 <- data[data$sample_time=="DAY8",]
dF22 <- data[data$sample_time=="DAY22",]
df8_22 <- rbind(dF8, dF22)
res.aov2 <- aov(digital_count ~trt_group+ sample_time, data = df8_22)
summary(res.aov2)

```
### If you had to analyze 1 million markers, how would you parallelize the tests from question 4 on a multi-processor machine? Please demonstrate this parallelization method using just the markers available in the spreadsheet
```{r warning=FALSE, echo = FALSE}

print("without parallelizing")
factMarker <- factor(data$marker)# This could be millions, but DAYs are fixed
factMarkerList <- levels(factMarker)

for (val in factMarkerList) {
  xA = data[data$marker == val & data$sample_time == "DAY1",]$digital_count
  xB = data[data$marker == val & data$sample_time == "DAY8",]$digital_count
  tTester <- t.test(xA, xB, alternative = c("two.sided"), mu = 0, paired = FALSE, conf.level = 0.95)
  print(tTester)
  
}


print("with parallelizing")

registerDoFuture()
plan(multiprocess)

factMarker <- factor(data$marker)
factMarkerList <- levels(factMarker)

y <- foreach(val = factMarkerList) %dopar% {
  xA = data[data$marker == val & data$sample_time == "DAY1",]$digital_count
  xB = data[data$marker == val & data$sample_time == "DAY8",]$digital_count
  tTester <- t.test(xA, xB, alternative = c("two.sided"), mu = 0, paired = FALSE, conf.level = 0.95)
  print(tTester)
}

```
### Please automate the table view for different layouts, i.e., write a function that takes the input data and another parameter indicating a categorical (nominal) variable so that the output of this function will produce a new table in which each level of the indicated variable become a separate column filled with corresponding digital_counts and others columns remain. In the data provided for the quiz, except "digital_count", all other variables are factors
```{r warning=FALSE, echo = FALSE}
library(tidyr)

new.function <- function(varX, dataX) {
  
  if (varX == "marker"){
    TableX <- dataX %>% tidyr::spread(marker, digital_count)
    TableT<- datatable(TableX, class = 'cell-border stripe')
    TableT
  }
  else if (varX == "trt_group"){
    TableX <- dataX %>% tidyr::spread(trt_group, digital_count)
    TableU<- datatable(TableX, class = 'cell-border stripe')
    TableU
  }
  else if (varX == "sample_time"){
    TableX <- dataX %>% tidyr::spread(sample_time, digital_count)
    TableV<- datatable(TableX, class = 'cell-border stripe')
    TableV
  }
  else if (varX == "sbj_id"){
    TableX <- dataX %>% tidyr::spread(sbj_id, digital_count)
    TableW<- datatable(TableX, class = 'cell-border stripe')
    TableW
  }                                                                                                                                                                                                                                                
  else if (varX == "sample_time"){
    TableX <- dataX %>% tidyr::spread(sbj_id, digital_count)
    TableY<- datatable(TableX, class = 'cell-border stripe')
    TableY
  }
  else  print ("Sorry! Dont know that value")
}
new.function("marker", data)
```
```{r warning=FALSE, echo = FALSE}
sessionInfo()
```